<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Leora Villa — Service Apartment Bookings</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #top { margin-bottom:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    #availability { margin-top:12px; max-width:1000px; }
    .apt-row { padding:8px; border:1px solid #ddd; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center; }
    .available { color: green; font-weight:600; }
    .booked { color: red; font-weight:600; }
    .lock { color: orange; font-weight:700; }
    .reply-buttons button { margin-left:6px; }
  </style>
  <script>
    const BUILDING_NAME = "{{ building_name|e }}";
  </script>
</head>
<body>
  <h1 style="margin-bottom:8px;">{{ building_name }} — Service Apartment Bookings</h1>

  <div id="top">
    Apartment:
    <select id="aptSelect"></select>
    <button id="newBookingBtn">New Booking</button>
    <button id="exportBtn">Export CSV</button>

    <div style="margin-left:20px;">
      <label>Check-in <input type="date" id="checkin"/></label>
      <label>Check-out <input type="date" id="checkout"/></label>
      <button id="checkAvailBtn">Check Availability</button>
    </div>
  </div>

  <div id="availability"></div>

  <div id="calendar" style="margin-top:20px;"></div>

<script>
let apartments = [];
let calendar, currentAptId = null;

async function fetchAparts(){
  let r = await fetch('/api/apartments'); apartments = await r.json();
  let sel = document.getElementById('aptSelect'); sel.innerHTML = '';
  apartments.forEach(a=>{
    let opt = document.createElement('option'); opt.value=a.id; opt.text = a.code + (a.name ? ' - '+a.name : '');
    sel.appendChild(opt);
  });
  if(apartments.length) {
    currentAptId = apartments[0].id;
    sel.value = currentAptId;
  }
}

async function fetchBookings(){
  let url = '/api/bookings' + (currentAptId ? ('?apartment_id='+currentAptId) : '');
  let r = await fetch(url);
  let data = await r.json();
  return data.map(b=>{
    let title = b.is_lock ? ('LOCKED') : b.guest_name;
    if(b.booking_type && b.booking_type.toUpperCase()==='LOCK') title = 'LOCKED';
    return {
      id: b.id,
      title: title,
      start: b.checkin,
      end: b.checkout,
      extendedProps: b,
      color: b.is_lock ? 'orange' : undefined
    };
  });
}

async function checkAvailability(checkin, checkout){
  const params = new URLSearchParams({checkin, checkout});
  const r = await fetch('/api/availability?' + params.toString());
  return r.json();
}

function makeReplyText(apartment, checkin, checkout, available, requested_type, requested_price){
  if(available){
    return `Hello,\n\n${apartment.code} (${apartment.name || requested_type || '2BHK'}) at ${BUILDING_NAME} is available from ${checkin} to ${checkout}.\nBooking type: ${requested_type}\nPrice quoted: ₹${requested_price}\nWould you like me to reserve it for you? Please share guest details.\n\nThanks,`;
  } else {
    const c = apartment.conflicts && apartment.conflicts[0];
    let conflictStr = c ? ` (booked ${c.checkin} → ${c.checkout}${c.is_lock ? ' — LOCK' : ''} )` : '';
    return `Hello,\n\nSorry — ${apartment.code} (${apartment.name || requested_type || '2BHK'}) at ${BUILDING_NAME} is NOT available from ${checkin} to ${checkout}.${conflictStr}\nWould you like another room or different dates?\n\nThanks,`;
  }
}

function createMailto(subject, body){
  return `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}

document.addEventListener('DOMContentLoaded', async function() {
  await fetchAparts();
  let calendarEl = document.getElementById('calendar');

  calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    events: async function(info, successCallback, failureCallback){
      let events = await fetchBookings();
      successCallback(events);
    },
    eventClick: function(info){
      let b = info.event.extendedProps;
      if(b.is_lock){
        alert('This is a LOCK record. It was created to keep the room unavailable while another guest uses a 1BHK.');
        return;
      }
      if(confirm('Edit booking for ' + b.guest_name + '? Cancel to delete.')) {
        let newCheckin = prompt('New check-in (YYYY-MM-DD)', b.checkin);
        let newCheckout = prompt('New check-out (YYYY-MM-DD)', b.checkout);
        if(newCheckin && newCheckout){
          fetch('/api/bookings/' + b.id, {
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({...b, checkin:newCheckin, checkout:newCheckout})
          }).then(async r=>{
            if(!r.ok) alert((await r.json()).error || 'Error'); else calendar.refetchEvents();
          });
        }
      } else {
        if(confirm('Delete this booking?')) {
          fetch('/api/bookings/' + b.id, {method:'DELETE'}).then(()=>calendar.refetchEvents());
        }
      }
    }
  });

  calendar.render();

  document.getElementById('aptSelect').addEventListener('change', (e)=>{ currentAptId = e.target.value; calendar.refetchEvents(); });

  document.getElementById('newBookingBtn').addEventListener('click', async ()=>{
    if(!currentAptId){ alert('Select apartment'); return;}
    let guest = prompt('Guest name'); if(!guest) return;
    let phone = prompt('Phone (optional)');
    let email = prompt('Email (optional)');
    let bookingType = prompt('Booking type: enter 2BHK or 1BHK', '2BHK');
    if(!bookingType) bookingType = '2BHK';
    bookingType = bookingType.toUpperCase();
    if(bookingType !== '2BHK' && bookingType !== '1BHK') bookingType = '2BHK';
    let checkin = prompt('Check-in (YYYY-MM-DD)');
    let checkout = prompt('Check-out (YYYY-MM-DD)');
    if(!checkin || !checkout) { alert('dates required'); return; }
    if(checkout <= checkin){ alert('Checkout must be after checkin'); return; }
    let price = prompt('Price quoted to customer (numeric)', '0');
    price = price ? parseFloat(price) : 0;
    let block_apartment_id = null;
    if(bookingType === '1BHK'){
      if(confirm('You will lock another room and give its key to this guest. Do you want to select which room to lock now?')){
        let aptList = apartments.filter(a => a.id != currentAptId);
        let listStr = aptList.map((a,i)=>`${i+1}. ${a.code} ${a.name?('- '+a.name):''}`).join('\n');
        let choice = prompt('Choose apartment to LOCK by number:\n' + listStr);
        if(choice){
          let idx = parseInt(choice)-1;
          if(idx>=0 && idx < aptList.length){
            block_apartment_id = aptList[idx].id;
          }
        }
      } else {
        alert('No lock selected — you may lock later by editing or creating a lock booking separately.');
      }
    }
    let body = {
      apartment_id: parseInt(currentAptId),
      guest_name: guest,
      guest_phone: phone,
      guest_email: email,
      checkin: checkin,
      checkout: checkout,
      booking_type: bookingType,
      price: price,
      notes: ''
    };
    if(block_apartment_id) body.block_apartment_id = block_apartment_id;
    let res = await fetch('/api/bookings', {
      method:'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if(!res.ok){
      let obj = await res.json();
      alert('Error: ' + (obj.error || 'unknown'));
    } else {
      calendar.refetchEvents();
      alert('Booked! If you locked another room, the app created a LOCK record and marked that room unavailable.');
    }
  });

  document.getElementById('exportBtn').addEventListener('click', ()=>{ window.location='/api/export'; });

  document.getElementById('checkAvailBtn').addEventListener('click', async ()=>{
    const checkin = document.getElementById('checkin').value;
    const checkout = document.getElementById('checkout').value;
    if(!checkin || !checkout){ alert('Select both dates'); return; }
    if(checkout <= checkin){ alert('Checkout must be after checkin'); return; }

    const requested_type = prompt('If booking, what type would the customer take? Enter 2BHK or 1BHK', '2BHK') || '2BHK';
    const requested_price = prompt('Price quoted (optional)', '0') || '0';

    const results = await checkAvailability(checkin, checkout);
    const container = document.getElementById('availability');
    container.innerHTML = '<h3>Availability</h3>';
    results.forEach(ap => {
      const row = document.createElement('div'); row.className = 'apt-row';
      const left = document.createElement('div');
      left.innerHTML = `<strong>${ap.code}</strong> ${ap.name ? '- '+ap.name : ''} &nbsp;`;
      const status = document.createElement('span');
      status.textContent = ap.available ? 'Available' : 'Booked';
      status.className = ap.available ? 'available' : 'booked';
      left.appendChild(status);

      if(!ap.available){
        const lockConf = (ap.conflicts || []).find(c => c.is_lock==1);
        if(lockConf){
          const lockSpan = document.createElement('div');
          lockSpan.innerHTML = `<small class="lock">Locked (key given) — ${lockConf.notes || ''}</small>`;
          left.appendChild(lockSpan);
        }
      }

      const right = document.createElement('div'); right.className = 'reply-buttons';
      const copyBtn = document.createElement('button');
      copyBtn.textContent = 'Copy Reply';
      copyBtn.addEventListener('click', async ()=>{
        const text = makeReplyText(ap, checkin, checkout, ap.available, requested_type.toUpperCase(), requested_price);
        if(navigator.clipboard){
          await navigator.clipboard.writeText(text);
          alert('Reply copied to clipboard — paste into WhatsApp/Message/Email.');
        } else {
          prompt('Copy this reply message', text);
        }
      });

      const mailBtn = document.createElement('button');
      mailBtn.textContent = 'Email Reply';
      mailBtn.addEventListener('click', ()=>{
        const body = makeReplyText(ap, checkin, checkout, ap.available, requested_type.toUpperCase(), requested_price);
        const subject = ap.available ? `${ap.code} available for your dates` : `${ap.code} not available`;
        window.location.href = createMailto(subject, body);
      });

      const bookBtn = document.createElement('button');
      bookBtn.textContent = 'Reserve';
      bookBtn.disabled = !ap.available;
      bookBtn.addEventListener('click', ()=>{
        document.getElementById('aptSelect').value = ap.id; currentAptId = ap.id;
        calendar.refetchEvents();
        alert('Now click "New Booking" and enter guest details to reserve. When creating 1BHK, choose the room to LOCK.');
      });

      right.appendChild(copyBtn);
      right.appendChild(mailBtn);
      right.appendChild(bookBtn);
      row.appendChild(left);
      row.appendChild(right);
      container.appendChild(row);
    });
  });

});
</script>
</body>
</html>
